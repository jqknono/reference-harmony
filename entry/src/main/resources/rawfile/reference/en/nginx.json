{
  "id": "nginx",
  "name": "Nginx",
  "title": "nginx quick reference cheat sheet",
  "icon": "https://raw.githubusercontent.com/Fechin/reference/main/source/assets/icon/nginx.svg",
  "sections": [
    {
      "id": "intro",
      "title": "Intro",
      "startIndex": 0
    },
    {
      "id": "s1",
      "title": "Getting Started",
      "startIndex": 1
    },
    {
      "id": "s2",
      "title": "Config Structure",
      "startIndex": 7
    },
    {
      "id": "s3",
      "title": "Virtual Hosts & Redirects",
      "startIndex": 12
    },
    {
      "id": "s4",
      "title": "TLS/SSL",
      "startIndex": 15
    },
    {
      "id": "s5",
      "title": "Static, Compression, Caching",
      "startIndex": 21
    },
    {
      "id": "s6",
      "title": "Caching & Microcaching",
      "startIndex": 24
    },
    {
      "id": "s7",
      "title": "PHP‑FPM / FastCGI",
      "startIndex": 27
    },
    {
      "id": "s8",
      "title": "Rewrites & Routing",
      "startIndex": 30
    },
    {
      "id": "s9",
      "title": "Rate Limiting & DoS Mitigation",
      "startIndex": 33
    },
    {
      "id": "s10",
      "title": "Security Headers & Access",
      "startIndex": 36
    },
    {
      "id": "s11",
      "title": "Logging & Debug",
      "startIndex": 39
    },
    {
      "id": "s12",
      "title": "Useful Variables",
      "startIndex": 44
    },
    {
      "id": "s13",
      "title": "Stream (TCP/UDP)",
      "startIndex": 57
    },
    {
      "id": "s14",
      "title": "Snippets",
      "startIndex": 60
    }
  ],
  "cards": [
    {
      "id": "intro-0",
      "sectionId": "intro",
      "title": "Intro",
      "kind": "text",
      "body": "nginx quick reference cheat sheet"
    },
    {
      "id": "s1-1",
      "sectionId": "s1",
      "title": "Install & Service",
      "kind": "text",
      "body": "• **Ubuntu/Debian**"
    },
    {
      "id": "s1-2",
      "sectionId": "s1",
      "title": "Install & Service",
      "kind": "text",
      "body": "```shell script\n$ sudo apt update && sudo apt install -y nginx"
    },
    {
      "id": "s1-3",
      "sectionId": "s1",
      "title": "Install & Service",
      "kind": "code",
      "lang": "",
      "code": "- **RHEL/CentOS**\n  ```shell script\n  $ sudo yum install -y epel-release nginx && sudo systemctl enable --now nginx"
    },
    {
      "id": "s1-4",
      "sectionId": "s1",
      "title": "Install & Service",
      "kind": "text",
      "body": "• **Service**"
    },
    {
      "id": "s1-5",
      "sectionId": "s1",
      "title": "Install & Service",
      "kind": "text",
      "body": "```shell script\n$ sudo systemctl status nginx\n$ sudo systemctl reload nginx\n$ sudo systemctl restart nginx\n$ sudo nginx -t   # test config\n$ nginx -V        # built modules"
    },
    {
      "id": "s1-6",
      "sectionId": "s1",
      "title": "Install & Service",
      "kind": "code",
      "lang": "",
      "code": "\n### Key Paths\n\n- `/etc/nginx/nginx.conf` _(main config)_\n- `/etc/nginx/conf.d/*.conf` _(drop‑ins)_\n- `/etc/nginx/sites-available/` + `sites-enabled/` _(Debian style)_\n- `/var/www/html` _(default docroot)_\n- `logs`: `/var/log/nginx/access.log`, `/var/log/nginx/error.log`\n\n### Minimal HTTP Server\n\n```nginx\n# /etc/nginx/conf.d/example.conf\nserver {\n  listen 80;\n  server_name example.com;\n  root /var/www/example/public;\n\n  location / {\n    try_files $uri $uri/ =404;\n  }\n}"
    },
    {
      "id": "s2-7",
      "sectionId": "s2",
      "title": "Core Blocks",
      "kind": "text",
      "body": "• `main` (global)\n• `events` (worker connections)\n• `http` → `server` → `location`\n• `stream` (TCP/UDP)\n• `upstream` (load balancers)"
    },
    {
      "id": "s2-8",
      "sectionId": "s2",
      "title": "Core Blocks",
      "kind": "code",
      "lang": "nginx",
      "code": "user  www-data;\nworker_processes auto;\n\nevents { worker_connections 1024; }\n\nhttp {\n  include       mime.types;\n  default_type  application/octet-stream;\n  sendfile      on;\n  keepalive_timeout 65;\n\n  # servers / includes go here...\n}"
    },
    {
      "id": "s2-9",
      "sectionId": "s2",
      "title": "Context & Order",
      "kind": "text",
      "body": "• **`location` match order**:\n• Exact `=`\n• `^~` (no regex if matched)\n• Regex `~` / `~*` (first match)\n• Prefix (longest path)\n• `try_files` evaluates in order then falls back."
    },
    {
      "id": "s2-10",
      "sectionId": "s2",
      "title": "Context & Order",
      "kind": "code",
      "lang": "nginx",
      "code": "location = /healthz { return 204; }\nlocation ^~ /static/ { expires 7d; }\nlocation ~* \\.(png|jpg|css|js)$ { expires 7d; }\nlocation / { try_files $uri $uri/ /index.html; }"
    },
    {
      "id": "s2-11",
      "sectionId": "s2",
      "title": "Common Includes",
      "kind": "code",
      "lang": "nginx",
      "code": "http {\n  include /etc/nginx/conf.d/*.conf;\n  include /etc/nginx/snippets/*.conf; # Ubuntu/Debian\n}"
    },
    {
      "id": "s3-12",
      "sectionId": "s3",
      "title": "Basic Server Block",
      "kind": "code",
      "lang": "nginx",
      "code": "server {\n  listen 80;\n  server_name example.com www.example.com;\n  root /var/www/example/public;\n  index index.html index.htm;\n}"
    },
    {
      "id": "s3-13",
      "sectionId": "s3",
      "title": "Redirect HTTP→HTTPS",
      "kind": "code",
      "lang": "nginx",
      "code": "server {\n  listen 80;\n  server_name example.com www.example.com;\n  return 301 https://example.com$request_uri;\n}"
    },
    {
      "id": "s3-14",
      "sectionId": "s3",
      "title": "Canonical Host",
      "kind": "code",
      "lang": "nginx",
      "code": "# Force non-www\nserver {\n  listen 80;\n  server_name www.example.com;\n  return 301 $scheme://example.com$request_uri;\n}"
    },
    {
      "id": "s4-15",
      "sectionId": "s4",
      "title": "Basic TLS Server",
      "kind": "code",
      "lang": "nginx",
      "code": "server {\n  listen 443 ssl http2;\n  server_name example.com;\n\n  ssl_certificate     /etc/letsencrypt/live/example.com/fullchain.pem;\n  ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;\n\n  ssl_protocols TLSv1.2 TLSv1.3;\n  ssl_prefer_server_ciphers off;\n\n  root /var/www/example/public;\n}"
    },
    {
      "id": "s4-16",
      "sectionId": "s4",
      "title": "HSTS & Security Headers",
      "kind": "code",
      "lang": "nginx",
      "code": "add_header Strict-Transport-Security \"max-age=31536000; includeSubDomains; preload\" always;\nadd_header X-Content-Type-Options \"nosniff\" always;\nadd_header X-Frame-Options \"SAMEORIGIN\" always;\nadd_header Referrer-Policy \"no-referrer-when-downgrade\" always;\nadd_header Permissions-Policy \"geolocation=(), microphone=(), camera=()\" always;"
    },
    {
      "id": "s4-17",
      "sectionId": "s4",
      "title": "Let’s Encrypt (Certbot)",
      "kind": "text",
      "body": "```shell script\n$ sudo apt install -y certbot python3-certbot-nginx\n$ sudo certbot --nginx -d example.com -d www.example.com\n$ sudo systemctl list-timers | grep certbot   # auto-renew"
    },
    {
      "id": "s4-18",
      "sectionId": "s4",
      "title": "Let’s Encrypt (Certbot)",
      "kind": "code",
      "lang": "",
      "code": "\n## Reverse Proxy {.cols-3}\n\n### Basic Proxy\n\n```nginx\nupstream app {\n  server 127.0.0.1:3000;\n  # server unix:/run/app.sock; # alternative\n}\n\nserver {\n  listen 80;\n  server_name api.example.com;\n\n  location / {\n    proxy_set_header Host $host;\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Proto $scheme;\n    proxy_pass http://app;\n  }\n}"
    },
    {
      "id": "s4-19",
      "sectionId": "s4",
      "title": "WebSockets / HTTP Upgrade",
      "kind": "code",
      "lang": "nginx",
      "code": "location /socket.io/ {\n  proxy_http_version 1.1;\n  proxy_set_header Upgrade $http_upgrade;\n  proxy_set_header Connection \"upgrade\";\n  proxy_pass http://app;\n}"
    },
    {
      "id": "s4-20",
      "sectionId": "s4",
      "title": "Timeouts & Buffers",
      "kind": "code",
      "lang": "nginx",
      "code": "proxy_connect_timeout 5s;\nproxy_send_timeout    60s;\nproxy_read_timeout    60s;\nproxy_buffering       on;\nproxy_buffers 16 16k;\nproxy_busy_buffers_size 24k;"
    },
    {
      "id": "s5-21",
      "sectionId": "s5",
      "title": "Static Files",
      "kind": "code",
      "lang": "nginx",
      "code": "location /assets/ {\n  alias /var/www/example/assets/;\n  access_log off;\n  expires 7d;\n  add_header Cache-Control \"public, max-age=604800, immutable\";\n}"
    },
    {
      "id": "s5-22",
      "sectionId": "s5",
      "title": "Gzip",
      "kind": "code",
      "lang": "nginx",
      "code": "gzip on;\ngzip_types text/plain text/css application/javascript application/json image/svg+xml;\ngzip_min_length 1024;\ngzip_comp_level 5;"
    },
    {
      "id": "s5-23",
      "sectionId": "s5",
      "title": "(Optional) Brotli (if compiled)",
      "kind": "code",
      "lang": "nginx",
      "code": "brotli on;\nbrotli_comp_level 5;\nbrotli_types text/plain text/css application/javascript application/json image/svg+xml;"
    },
    {
      "id": "s6-24",
      "sectionId": "s6",
      "title": "Proxy Cache Zone",
      "kind": "code",
      "lang": "nginx",
      "code": "proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=micro:10m max_size=1g inactive=10m use_temp_path=off;\nmap $request_method $no_cache { default 0; POST 1; PUT 1; PATCH 1; DELETE 1; }"
    },
    {
      "id": "s6-25",
      "sectionId": "s6",
      "title": "Use the Cache",
      "kind": "code",
      "lang": "nginx",
      "code": "location /api/ {\n  proxy_cache micro;\n  proxy_cache_bypass $no_cache;\n  proxy_no_cache $no_cache;\n  proxy_cache_valid 200 301 302 10s;\n  proxy_cache_valid any 1s;\n  add_header X-Cache-Status $upstream_cache_status;\n  proxy_pass http://app;\n}"
    },
    {
      "id": "s6-26",
      "sectionId": "s6",
      "title": "Conditional Bypass",
      "kind": "code",
      "lang": "nginx",
      "code": "# Skip cache when logged in (example cookie)\nmap $http_cookie $logged_in {\n  default 0;\n  ~*\"(session|auth|logged_in)\" 1;\n}\nproxy_cache_bypass $logged_in;\nproxy_no_cache $logged_in;"
    },
    {
      "id": "s7-27",
      "sectionId": "s7",
      "title": "Basic PHP Handler",
      "kind": "code",
      "lang": "nginx",
      "code": "location ~ \\.php$ {\n  include fastcgi_params;\n  fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;\n  fastcgi_param DOCUMENT_ROOT $realpath_root;\n  fastcgi_pass unix:/run/php/php8.2-fpm.sock;\n  fastcgi_buffers 16 16k;\n  fastcgi_read_timeout 60s;\n}"
    },
    {
      "id": "s7-28",
      "sectionId": "s7",
      "title": "try_files Front Controller",
      "kind": "code",
      "lang": "nginx",
      "code": "location / {\n  try_files $uri $uri/ /index.php?$args;\n}"
    },
    {
      "id": "s7-29",
      "sectionId": "s7",
      "title": "Security Tips",
      "kind": "code",
      "lang": "nginx",
      "code": "location ~* \\.(?:ini|log|sh|sql|bak)$ { deny all; }\nlocation ~ /\\.(?!well-known) { deny all; }"
    },
    {
      "id": "s8-30",
      "sectionId": "s8",
      "title": "try_files",
      "kind": "code",
      "lang": "nginx",
      "code": "location / {\n  try_files $uri $uri/ /index.html;\n}"
    },
    {
      "id": "s8-31",
      "sectionId": "s8",
      "title": "Regex Rewrites",
      "kind": "code",
      "lang": "nginx",
      "code": "# Remove trailing slash (except root)\nif ($request_uri ~* \"^(.+)/+$\") { return 301 $1; }\n\n# Legacy path to new path\nrewrite ^/old/(.*)$ /new/$1 permanent;"
    },
    {
      "id": "s8-32",
      "sectionId": "s8",
      "title": "SPA / History API",
      "kind": "code",
      "lang": "nginx",
      "code": "location / {\n  try_files $uri /index.html;\n}"
    },
    {
      "id": "s9-33",
      "sectionId": "s9",
      "title": "Request Rate",
      "kind": "code",
      "lang": "nginx",
      "code": "# 10 req/s with burst 20 per IP\nlimit_req_zone $binary_remote_addr zone=reqs:10m rate=10r/s;\n\nserver {\n  location /api/ {\n    limit_req zone=reqs burst=20 nodelay;\n  }\n}"
    },
    {
      "id": "s9-34",
      "sectionId": "s9",
      "title": "Concurrent Connections",
      "kind": "code",
      "lang": "nginx",
      "code": "limit_conn_zone $binary_remote_addr zone=conns:10m;\nserver {\n  location /download/ {\n    limit_conn conns 10;\n  }\n}"
    },
    {
      "id": "s9-35",
      "sectionId": "s9",
      "title": "Body Size & Timeouts",
      "kind": "code",
      "lang": "nginx",
      "code": "client_max_body_size 25m;\nclient_body_timeout 30s;\nkeepalive_timeout 65s;"
    },
    {
      "id": "s10-36",
      "sectionId": "s10",
      "title": "Basic Hardening",
      "kind": "code",
      "lang": "nginx",
      "code": "server_tokens off;\nadd_header X-Content-Type-Options \"nosniff\" always;\nadd_header X-Frame-Options \"SAMEORIGIN\" always;\nadd_header Referrer-Policy \"no-referrer-when-downgrade\" always;"
    },
    {
      "id": "s10-37",
      "sectionId": "s10",
      "title": "Allow/Deny",
      "kind": "code",
      "lang": "nginx",
      "code": "location /admin/ {\n  allow 192.168.0.0/16;\n  deny all;\n}"
    },
    {
      "id": "s10-38",
      "sectionId": "s10",
      "title": "CORS (Example)",
      "kind": "code",
      "lang": "nginx",
      "code": "location /api/ {\n  add_header Access-Control-Allow-Origin \"https://app.example.com\" always;\n  add_header Access-Control-Allow-Credentials \"true\" always;\n  if ($request_method = OPTIONS) {\n    add_header Access-Control-Allow-Methods \"GET, POST, OPTIONS\";\n    add_header Access-Control-Allow-Headers \"Authorization, Content-Type\";\n    return 204;\n  }\n  proxy_pass http://app;\n}"
    },
    {
      "id": "s11-39",
      "sectionId": "s11",
      "title": "Formats",
      "kind": "code",
      "lang": "nginx",
      "code": "log_format main '$remote_addr - $remote_user [$time_local] \"$request\" '\n                '$status $body_bytes_sent \"$http_referer\" '\n                '\"$http_user_agent\" \"$http_x_forwarded_for\" '\n                '$request_time $upstream_response_time';\n\naccess_log /var/log/nginx/access.log main;\nerror_log  /var/log/nginx/error.log warn;"
    },
    {
      "id": "s11-40",
      "sectionId": "s11",
      "title": "Per‑Location Logging",
      "kind": "code",
      "lang": "nginx",
      "code": "location /healthz { access_log off; }"
    },
    {
      "id": "s11-41",
      "sectionId": "s11",
      "title": "Debugging",
      "kind": "text",
      "body": "```shell script\n$ sudo nginx -t\n$ sudo nginx -s reload\n$ tail -f /var/log/nginx/error.log"
    },
    {
      "id": "s11-42",
      "sectionId": "s11",
      "title": "Debugging",
      "kind": "code",
      "lang": "",
      "code": "\n## Upstreams & LB {.cols-3}\n\n### Strategies\n\n| Directive     | Meaning                 |\n| ------------- | ----------------------- |\n| (default)     | round‑robin             |\n| `least_conn`  | least connections       |\n| `ip_hash`     | sticky by client IP     |\n| `hash key`    | hash by custom key      |\n\n{.show-header}\n\n### Example Upstream\n\n```nginx\nupstream api_backends {\n  least_conn;\n  server 10.0.0.11:8080 max_fails=3 fail_timeout=30s;\n  server 10.0.0.12:8080 max_fails=3 fail_timeout=30s;\n  # server backup.example:8080 backup;\n}"
    },
    {
      "id": "s11-43",
      "sectionId": "s11",
      "title": "Health & Failover",
      "kind": "code",
      "lang": "nginx",
      "code": "proxy_next_upstream error timeout http_502 http_503 http_504;\nproxy_next_upstream_tries 3;"
    },
    {
      "id": "s12-44",
      "sectionId": "s12",
      "title": "Request & Client",
      "kind": "qa",
      "front": "`$host`",
      "back": "Host header / server name"
    },
    {
      "id": "s12-45",
      "sectionId": "s12",
      "title": "Request & Client",
      "kind": "qa",
      "front": "`$server_name`",
      "back": "Chosen server_name"
    },
    {
      "id": "s12-46",
      "sectionId": "s12",
      "title": "Request & Client",
      "kind": "qa",
      "front": "`$remote_addr`",
      "back": "Client IP"
    },
    {
      "id": "s12-47",
      "sectionId": "s12",
      "title": "Request & Client",
      "kind": "qa",
      "front": "`$http_user_agent`",
      "back": "User‑Agent"
    },
    {
      "id": "s12-48",
      "sectionId": "s12",
      "title": "Request & Client",
      "kind": "qa",
      "front": "`$request_method`",
      "back": "GET/POST/..."
    },
    {
      "id": "s12-49",
      "sectionId": "s12",
      "title": "Paths & Files",
      "kind": "qa",
      "front": "`$document_root`",
      "back": "Current root"
    },
    {
      "id": "s12-50",
      "sectionId": "s12",
      "title": "Paths & Files",
      "kind": "qa",
      "front": "`$realpath_root`",
      "back": "Symlink‑resolved root"
    },
    {
      "id": "s12-51",
      "sectionId": "s12",
      "title": "Paths & Files",
      "kind": "qa",
      "front": "`$request_uri`",
      "back": "Path + query"
    },
    {
      "id": "s12-52",
      "sectionId": "s12",
      "title": "Paths & Files",
      "kind": "qa",
      "front": "`$uri`",
      "back": "Normalized URI"
    },
    {
      "id": "s12-53",
      "sectionId": "s12",
      "title": "Paths & Files",
      "kind": "qa",
      "front": "`$args`",
      "back": "Raw query string"
    },
    {
      "id": "s12-54",
      "sectionId": "s12",
      "title": "Upstream",
      "kind": "qa",
      "front": "`$upstream_addr`",
      "back": "Upstream server(s)"
    },
    {
      "id": "s12-55",
      "sectionId": "s12",
      "title": "Upstream",
      "kind": "qa",
      "front": "`$upstream_status`",
      "back": "Upstream status"
    },
    {
      "id": "s12-56",
      "sectionId": "s12",
      "title": "Upstream",
      "kind": "qa",
      "front": "`$upstream_response_time`",
      "back": "Time from upstream"
    },
    {
      "id": "s13-57",
      "sectionId": "s13",
      "title": "TCP Proxy",
      "kind": "code",
      "lang": "nginx",
      "code": "stream {\n  upstream db {\n    server 10.0.0.10:5432;\n    server 10.0.0.11:5432;\n  }\n  server {\n    listen 5432;\n    proxy_pass db;\n  }\n}"
    },
    {
      "id": "s13-58",
      "sectionId": "s13",
      "title": "UDP Proxy",
      "kind": "code",
      "lang": "nginx",
      "code": "stream {\n  server {\n    listen 53 udp;\n    proxy_responses 1;\n    proxy_timeout 2s;\n    proxy_pass 1.1.1.1:53;\n  }\n}"
    },
    {
      "id": "s13-59",
      "sectionId": "s13",
      "title": "Access Control",
      "kind": "code",
      "lang": "nginx",
      "code": "stream {\n  server {\n    listen 6379;\n    allow 10.0.0.0/8;\n    deny all;\n    proxy_pass 127.0.0.1:6379;\n  }\n}"
    },
    {
      "id": "s14-60",
      "sectionId": "s14",
      "title": "Security Snippet",
      "kind": "code",
      "lang": "nginx",
      "code": "# /etc/nginx/snippets/security.conf\nserver_tokens off;\nadd_header X-Content-Type-Options \"nosniff\" always;\nadd_header X-Frame-Options \"SAMEORIGIN\" always;\nadd_header Referrer-Policy \"no-referrer-when-downgrade\" always;"
    },
    {
      "id": "s14-61",
      "sectionId": "s14",
      "title": "PHP Snippet",
      "kind": "code",
      "lang": "nginx",
      "code": "# /etc/nginx/snippets/fastcgi-php.conf\nlocation ~ \\.php$ {\n  include fastcgi_params;\n  fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;\n  fastcgi_param DOCUMENT_ROOT $realpath_root;\n  fastcgi_pass unix:/run/php/php8.2-fpm.sock;\n}"
    },
    {
      "id": "s14-62",
      "sectionId": "s14",
      "title": "Proxy Headers Snippet",
      "kind": "code",
      "lang": "nginx",
      "code": "# /etc/nginx/snippets/proxy-headers.conf\nproxy_set_header Host $host;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\nproxy_set_header X-Forwarded-Proto $scheme;"
    }
  ],
  "source": {
    "repo": "https://github.com/Fechin/reference",
    "path": "source/_posts/nginx.md",
    "ref": "main",
    "url": "https://github.com/Fechin/reference/tree/main/source/_posts/nginx.md",
    "lang": "en",
    "mode": "local"
  }
}