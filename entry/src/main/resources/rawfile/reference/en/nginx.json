{
  "id": "nginx",
  "name": "Nginx",
  "title": "nginx quick reference cheat sheet",
  "icon": "https://raw.githubusercontent.com/Fechin/reference/main/source/assets/icon/nginx.svg",
  "sections": [
    {
      "id": "intro",
      "title": "Intro",
      "startIndex": 0
    },
    {
      "id": "s1",
      "title": "Getting Started",
      "startIndex": 1
    },
    {
      "id": "s2",
      "title": "Config Structure",
      "startIndex": 7
    },
    {
      "id": "s3",
      "title": "Virtual Hosts & Redirects",
      "startIndex": 12
    },
    {
      "id": "s4",
      "title": "TLS/SSL",
      "startIndex": 15
    },
    {
      "id": "s5",
      "title": "Static, Compression, Caching",
      "startIndex": 21
    },
    {
      "id": "s6",
      "title": "Caching & Microcaching",
      "startIndex": 24
    },
    {
      "id": "s7",
      "title": "PHP‑FPM / FastCGI",
      "startIndex": 27
    },
    {
      "id": "s8",
      "title": "Rewrites & Routing",
      "startIndex": 30
    },
    {
      "id": "s9",
      "title": "Rate Limiting & DoS Mitigation",
      "startIndex": 33
    },
    {
      "id": "s10",
      "title": "Security Headers & Access",
      "startIndex": 36
    },
    {
      "id": "s11",
      "title": "Logging & Debug",
      "startIndex": 39
    },
    {
      "id": "s12",
      "title": "Useful Variables",
      "startIndex": 44
    },
    {
      "id": "s13",
      "title": "Stream (TCP/UDP)",
      "startIndex": 47
    },
    {
      "id": "s14",
      "title": "Snippets",
      "startIndex": 50
    }
  ],
  "cards": [
    {
      "id": "intro-0",
      "sectionId": "intro",
      "title": "Intro",
      "body": "nginx quick reference cheat sheet"
    },
    {
      "id": "s1-1",
      "sectionId": "s1",
      "title": "Install & Service",
      "body": "• **Ubuntu/Debian**\n\n```shell script\n$ sudo apt update && sudo apt install -y nginx\n\n  ```\n- **RHEL/CentOS**\n  ```shell script\n  $ sudo yum install -y epel-release nginx && sudo systemctl enable --now nginx\n  ```\n\n• **Service**\n\n```shell script\n$ sudo systemctl status nginx\n$ sudo systemctl reload nginx\n$ sudo systemctl restart nginx\n$ sudo nginx -t   # test config\n$ nginx -V        # built modules\n\n  ```\n\n### Key Paths\n\n- `/etc/nginx/nginx.conf` _(main config)_\n- `/etc/nginx/conf.d/*.conf` _(drop‑ins)_\n- `/etc/nginx/sites-available/` + `sites-enabled/` _(Debian style)_\n- `/var/www/html` _(default docroot)_\n- `logs`: `/var/log/nginx/access.log`, `/var/log/nginx/error.log`\n\n### Minimal HTTP Server\n\n```nginx\n# /etc/nginx/conf.d/example.conf\nserver {\n  listen 80;\n  server_name example.com;\n  root /var/www/example/public;\n\n  location / {\n    try_files $uri $uri/ =404;\n  }\n}\n```"
    },
    {
      "id": "s2-7",
      "sectionId": "s2",
      "title": "Core Blocks",
      "body": "• `main` (global)\n• `events` (worker connections)\n• `http` → `server` → `location`\n• `stream` (TCP/UDP)\n• `upstream` (load balancers)\n\n```nginx\nuser  www-data;\nworker_processes auto;\n\nevents { worker_connections 1024; }\n\nhttp {\n  include       mime.types;\n  default_type  application/octet-stream;\n  sendfile      on;\n  keepalive_timeout 65;\n\n  # servers / includes go here...\n}\n```"
    },
    {
      "id": "s2-9",
      "sectionId": "s2",
      "title": "Context & Order",
      "body": "• **`location` match order**:\n• Exact `=`\n• `^~` (no regex if matched)\n• Regex `~` / `~*` (first match)\n• Prefix (longest path)\n• `try_files` evaluates in order then falls back.\n\n```nginx\nlocation = /healthz { return 204; }\nlocation ^~ /static/ { expires 7d; }\nlocation ~* \\.(png|jpg|css|js)$ { expires 7d; }\nlocation / { try_files $uri $uri/ /index.html; }\n```"
    },
    {
      "id": "s2-11",
      "sectionId": "s2",
      "title": "Common Includes",
      "body": "```nginx\nhttp {\n  include /etc/nginx/conf.d/*.conf;\n  include /etc/nginx/snippets/*.conf; # Ubuntu/Debian\n}\n```"
    },
    {
      "id": "s3-12",
      "sectionId": "s3",
      "title": "Basic Server Block",
      "body": "```nginx\nserver {\n  listen 80;\n  server_name example.com www.example.com;\n  root /var/www/example/public;\n  index index.html index.htm;\n}\n```"
    },
    {
      "id": "s3-13",
      "sectionId": "s3",
      "title": "Redirect HTTP→HTTPS",
      "body": "```nginx\nserver {\n  listen 80;\n  server_name example.com www.example.com;\n  return 301 https://example.com$request_uri;\n}\n```"
    },
    {
      "id": "s3-14",
      "sectionId": "s3",
      "title": "Canonical Host",
      "body": "```nginx\n# Force non-www\nserver {\n  listen 80;\n  server_name www.example.com;\n  return 301 $scheme://example.com$request_uri;\n}\n```"
    },
    {
      "id": "s4-15",
      "sectionId": "s4",
      "title": "Basic TLS Server",
      "body": "```nginx\nserver {\n  listen 443 ssl http2;\n  server_name example.com;\n\n  ssl_certificate     /etc/letsencrypt/live/example.com/fullchain.pem;\n  ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;\n\n  ssl_protocols TLSv1.2 TLSv1.3;\n  ssl_prefer_server_ciphers off;\n\n  root /var/www/example/public;\n}\n```"
    },
    {
      "id": "s4-16",
      "sectionId": "s4",
      "title": "HSTS%20%26%20Security%20Headers",
      "body": "%60%60%60nginx%0Aadd_header%20Strict-Transport-Security%20%22max-age%3D31536000%3B%20includeSubDomains%3B%20preload%22%20always%3B%0Aadd_header%20X-Content-Type-Options%20%22nosniff%22%20always%3B%0Aadd_header%20X-Frame-Options%20%22SAMEORIGIN%22%20always%3B%0Aadd_header%20Referrer-Policy%20%22no-referrer-when-downgrade%22%20always%3B%0Aadd_header%20Permissions-Policy%20%22geolocation%3D()%2C%20microphone%3D()%2C%20camera%3D()%22%20always%3B%0A%60%60%60",
      "encoded": true
    },
    {
      "id": "s4-17",
      "sectionId": "s4",
      "title": "Let’s Encrypt (Certbot)",
      "body": "```shell script\n$ sudo apt install -y certbot python3-certbot-nginx\n$ sudo certbot --nginx -d example.com -d www.example.com\n$ sudo systemctl list-timers | grep certbot   # auto-renew\n\n```\n\n## Reverse Proxy {.cols-3}\n\n### Basic Proxy\n\n```nginx\nupstream app {\n  server 127.0.0.1:3000;\n  # server unix:/run/app.sock; # alternative\n}\n\nserver {\n  listen 80;\n  server_name api.example.com;\n\n  location / {\n    proxy_set_header Host $host;\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Proto $scheme;\n    proxy_pass http://app;\n  }\n}\n```"
    },
    {
      "id": "s4-19",
      "sectionId": "s4",
      "title": "WebSockets%20%2F%20HTTP%20Upgrade",
      "body": "%60%60%60nginx%0Alocation%20%2Fsocket.io%2F%20%7B%0A%20%20proxy_http_version%201.1%3B%0A%20%20proxy_set_header%20Upgrade%20%24http_upgrade%3B%0A%20%20proxy_set_header%20Connection%20%22upgrade%22%3B%0A%20%20proxy_pass%20http%3A%2F%2Fapp%3B%0A%7D%0A%60%60%60",
      "encoded": true
    },
    {
      "id": "s4-20",
      "sectionId": "s4",
      "title": "Timeouts & Buffers",
      "body": "```nginx\nproxy_connect_timeout 5s;\nproxy_send_timeout    60s;\nproxy_read_timeout    60s;\nproxy_buffering       on;\nproxy_buffers 16 16k;\nproxy_busy_buffers_size 24k;\n```"
    },
    {
      "id": "s5-21",
      "sectionId": "s5",
      "title": "Static%20Files",
      "body": "%60%60%60nginx%0Alocation%20%2Fassets%2F%20%7B%0A%20%20alias%20%2Fvar%2Fwww%2Fexample%2Fassets%2F%3B%0A%20%20access_log%20off%3B%0A%20%20expires%207d%3B%0A%20%20add_header%20Cache-Control%20%22public%2C%20max-age%3D604800%2C%20immutable%22%3B%0A%7D%0A%60%60%60",
      "encoded": true
    },
    {
      "id": "s5-22",
      "sectionId": "s5",
      "title": "Gzip",
      "body": "```nginx\ngzip on;\ngzip_types text/plain text/css application/javascript application/json image/svg+xml;\ngzip_min_length 1024;\ngzip_comp_level 5;\n```"
    },
    {
      "id": "s5-23",
      "sectionId": "s5",
      "title": "(Optional) Brotli (if compiled)",
      "body": "```nginx\nbrotli on;\nbrotli_comp_level 5;\nbrotli_types text/plain text/css application/javascript application/json image/svg+xml;\n```"
    },
    {
      "id": "s6-24",
      "sectionId": "s6",
      "title": "Proxy Cache Zone",
      "body": "```nginx\nproxy_cache_path /var/cache/nginx levels=1:2 keys_zone=micro:10m max_size=1g inactive=10m use_temp_path=off;\nmap $request_method $no_cache { default 0; POST 1; PUT 1; PATCH 1; DELETE 1; }\n```"
    },
    {
      "id": "s6-25",
      "sectionId": "s6",
      "title": "Use the Cache",
      "body": "```nginx\nlocation /api/ {\n  proxy_cache micro;\n  proxy_cache_bypass $no_cache;\n  proxy_no_cache $no_cache;\n  proxy_cache_valid 200 301 302 10s;\n  proxy_cache_valid any 1s;\n  add_header X-Cache-Status $upstream_cache_status;\n  proxy_pass http://app;\n}\n```"
    },
    {
      "id": "s6-26",
      "sectionId": "s6",
      "title": "Conditional%20Bypass",
      "body": "%60%60%60nginx%0A%23%20Skip%20cache%20when%20logged%20in%20(example%20cookie)%0Amap%20%24http_cookie%20%24logged_in%20%7B%0A%20%20default%200%3B%0A%20%20~*%22(session%7Cauth%7Clogged_in)%22%201%3B%0A%7D%0Aproxy_cache_bypass%20%24logged_in%3B%0Aproxy_no_cache%20%24logged_in%3B%0A%60%60%60",
      "encoded": true
    },
    {
      "id": "s7-27",
      "sectionId": "s7",
      "title": "Basic PHP Handler",
      "body": "```nginx\nlocation ~ \\.php$ {\n  include fastcgi_params;\n  fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;\n  fastcgi_param DOCUMENT_ROOT $realpath_root;\n  fastcgi_pass unix:/run/php/php8.2-fpm.sock;\n  fastcgi_buffers 16 16k;\n  fastcgi_read_timeout 60s;\n}\n```"
    },
    {
      "id": "s7-28",
      "sectionId": "s7",
      "title": "try_files Front Controller",
      "body": "```nginx\nlocation / {\n  try_files $uri $uri/ /index.php?$args;\n}\n```"
    },
    {
      "id": "s7-29",
      "sectionId": "s7",
      "title": "Security Tips",
      "body": "```nginx\nlocation ~* \\.(?:ini|log|sh|sql|bak)$ { deny all; }\nlocation ~ /\\.(?!well-known) { deny all; }\n```"
    },
    {
      "id": "s8-30",
      "sectionId": "s8",
      "title": "try_files",
      "body": "```nginx\nlocation / {\n  try_files $uri $uri/ /index.html;\n}\n```"
    },
    {
      "id": "s8-31",
      "sectionId": "s8",
      "title": "Regex%20Rewrites",
      "body": "%60%60%60nginx%0A%23%20Remove%20trailing%20slash%20(except%20root)%0Aif%20(%24request_uri%20~*%20%22%5E(.%2B)%2F%2B%24%22)%20%7B%20return%20301%20%241%3B%20%7D%0A%0A%23%20Legacy%20path%20to%20new%20path%0Arewrite%20%5E%2Fold%2F(.*)%24%20%2Fnew%2F%241%20permanent%3B%0A%60%60%60",
      "encoded": true
    },
    {
      "id": "s8-32",
      "sectionId": "s8",
      "title": "SPA / History API",
      "body": "```nginx\nlocation / {\n  try_files $uri /index.html;\n}\n```"
    },
    {
      "id": "s9-33",
      "sectionId": "s9",
      "title": "Request Rate",
      "body": "```nginx\n# 10 req/s with burst 20 per IP\nlimit_req_zone $binary_remote_addr zone=reqs:10m rate=10r/s;\n\nserver {\n  location /api/ {\n    limit_req zone=reqs burst=20 nodelay;\n  }\n}\n```"
    },
    {
      "id": "s9-34",
      "sectionId": "s9",
      "title": "Concurrent Connections",
      "body": "```nginx\nlimit_conn_zone $binary_remote_addr zone=conns:10m;\nserver {\n  location /download/ {\n    limit_conn conns 10;\n  }\n}\n```"
    },
    {
      "id": "s9-35",
      "sectionId": "s9",
      "title": "Body Size & Timeouts",
      "body": "```nginx\nclient_max_body_size 25m;\nclient_body_timeout 30s;\nkeepalive_timeout 65s;\n```"
    },
    {
      "id": "s10-36",
      "sectionId": "s10",
      "title": "Basic%20Hardening",
      "body": "%60%60%60nginx%0Aserver_tokens%20off%3B%0Aadd_header%20X-Content-Type-Options%20%22nosniff%22%20always%3B%0Aadd_header%20X-Frame-Options%20%22SAMEORIGIN%22%20always%3B%0Aadd_header%20Referrer-Policy%20%22no-referrer-when-downgrade%22%20always%3B%0A%60%60%60",
      "encoded": true
    },
    {
      "id": "s10-37",
      "sectionId": "s10",
      "title": "Allow/Deny",
      "body": "```nginx\nlocation /admin/ {\n  allow 192.168.0.0/16;\n  deny all;\n}\n```"
    },
    {
      "id": "s10-38",
      "sectionId": "s10",
      "title": "CORS%20(Example)",
      "body": "%60%60%60nginx%0Alocation%20%2Fapi%2F%20%7B%0A%20%20add_header%20Access-Control-Allow-Origin%20%22https%3A%2F%2Fapp.example.com%22%20always%3B%0A%20%20add_header%20Access-Control-Allow-Credentials%20%22true%22%20always%3B%0A%20%20if%20(%24request_method%20%3D%20OPTIONS)%20%7B%0A%20%20%20%20add_header%20Access-Control-Allow-Methods%20%22GET%2C%20POST%2C%20OPTIONS%22%3B%0A%20%20%20%20add_header%20Access-Control-Allow-Headers%20%22Authorization%2C%20Content-Type%22%3B%0A%20%20%20%20return%20204%3B%0A%20%20%7D%0A%20%20proxy_pass%20http%3A%2F%2Fapp%3B%0A%7D%0A%60%60%60",
      "encoded": true
    },
    {
      "id": "s11-39",
      "sectionId": "s11",
      "title": "Formats",
      "body": "%60%60%60nginx%0Alog_format%20main%20'%24remote_addr%20-%20%24remote_user%20%5B%24time_local%5D%20%22%24request%22%20'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'%24status%20%24body_bytes_sent%20%22%24http_referer%22%20'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'%22%24http_user_agent%22%20%22%24http_x_forwarded_for%22%20'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'%24request_time%20%24upstream_response_time'%3B%0A%0Aaccess_log%20%2Fvar%2Flog%2Fnginx%2Faccess.log%20main%3B%0Aerror_log%20%20%2Fvar%2Flog%2Fnginx%2Ferror.log%20warn%3B%0A%60%60%60",
      "encoded": true
    },
    {
      "id": "s11-40",
      "sectionId": "s11",
      "title": "Per‑Location Logging",
      "body": "```nginx\nlocation /healthz { access_log off; }\n```"
    },
    {
      "id": "s11-41",
      "sectionId": "s11",
      "title": "Debugging",
      "body": "```shell script\n$ sudo nginx -t\n$ sudo nginx -s reload\n$ tail -f /var/log/nginx/error.log\n\n```\n\n## Upstreams & LB {.cols-3}\n\n### Strategies\n\n| Directive     | Meaning                 |\n| ------------- | ----------------------- |\n| (default)     | round‑robin             |\n| `least_conn`  | least connections       |\n| `ip_hash`     | sticky by client IP     |\n| `hash key`    | hash by custom key      |\n\n{.show-header}\n\n### Example Upstream\n\n```nginx\nupstream api_backends {\n  least_conn;\n  server 10.0.0.11:8080 max_fails=3 fail_timeout=30s;\n  server 10.0.0.12:8080 max_fails=3 fail_timeout=30s;\n  # server backup.example:8080 backup;\n}\n```"
    },
    {
      "id": "s11-43",
      "sectionId": "s11",
      "title": "Health & Failover",
      "body": "```nginx\nproxy_next_upstream error timeout http_502 http_503 http_504;\nproxy_next_upstream_tries 3;\n```"
    },
    {
      "id": "s12-44",
      "sectionId": "s12",
      "title": "Request & Client",
      "body": "| Variable               | Description                  |\n| --------------------- | ---------------------------- |\n| `$host`               | Host header / server name    |\n| `$server_name`        | Chosen server_name           |\n| `$remote_addr`        | Client IP                    |\n| `$http_user_agent`    | User‑Agent                   |\n| `$request_method`     | GET/POST/...                 |"
    },
    {
      "id": "s12-45",
      "sectionId": "s12",
      "title": "Paths & Files",
      "body": "| Variable                 | Description            |\n| ----------------------- | ---------------------- |\n| `$document_root`        | Current root           |\n| `$realpath_root`        | Symlink‑resolved root  |\n| `$request_uri`          | Path + query           |\n| `$uri`                  | Normalized URI         |\n| `$args`                 | Raw query string       |"
    },
    {
      "id": "s12-46",
      "sectionId": "s12",
      "title": "Upstream",
      "body": "| Variable                    | Description        |\n| -------------------------- | ------------------ |\n| `$upstream_addr`           | Upstream server(s) |\n| `$upstream_status`         | Upstream status    |\n| `$upstream_response_time`  | Time from upstream |"
    },
    {
      "id": "s13-47",
      "sectionId": "s13",
      "title": "TCP Proxy",
      "body": "```nginx\nstream {\n  upstream db {\n    server 10.0.0.10:5432;\n    server 10.0.0.11:5432;\n  }\n  server {\n    listen 5432;\n    proxy_pass db;\n  }\n}\n```"
    },
    {
      "id": "s13-48",
      "sectionId": "s13",
      "title": "UDP Proxy",
      "body": "```nginx\nstream {\n  server {\n    listen 53 udp;\n    proxy_responses 1;\n    proxy_timeout 2s;\n    proxy_pass 1.1.1.1:53;\n  }\n}\n```"
    },
    {
      "id": "s13-49",
      "sectionId": "s13",
      "title": "Access Control",
      "body": "```nginx\nstream {\n  server {\n    listen 6379;\n    allow 10.0.0.0/8;\n    deny all;\n    proxy_pass 127.0.0.1:6379;\n  }\n}\n```"
    },
    {
      "id": "s14-50",
      "sectionId": "s14",
      "title": "Security%20Snippet",
      "body": "%60%60%60nginx%0A%23%20%2Fetc%2Fnginx%2Fsnippets%2Fsecurity.conf%0Aserver_tokens%20off%3B%0Aadd_header%20X-Content-Type-Options%20%22nosniff%22%20always%3B%0Aadd_header%20X-Frame-Options%20%22SAMEORIGIN%22%20always%3B%0Aadd_header%20Referrer-Policy%20%22no-referrer-when-downgrade%22%20always%3B%0A%60%60%60",
      "encoded": true
    },
    {
      "id": "s14-51",
      "sectionId": "s14",
      "title": "PHP Snippet",
      "body": "```nginx\n# /etc/nginx/snippets/fastcgi-php.conf\nlocation ~ \\.php$ {\n  include fastcgi_params;\n  fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;\n  fastcgi_param DOCUMENT_ROOT $realpath_root;\n  fastcgi_pass unix:/run/php/php8.2-fpm.sock;\n}\n```"
    },
    {
      "id": "s14-52",
      "sectionId": "s14",
      "title": "Proxy Headers Snippet",
      "body": "```nginx\n# /etc/nginx/snippets/proxy-headers.conf\nproxy_set_header Host $host;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\nproxy_set_header X-Forwarded-Proto $scheme;\n```"
    }
  ],
  "source": {
    "repo": "https://github.com/Fechin/reference",
    "path": "source/_posts/nginx.md",
    "ref": "main",
    "url": "https://github.com/Fechin/reference/tree/main/source/_posts/nginx.md",
    "lang": "en",
    "mode": "local"
  }
}