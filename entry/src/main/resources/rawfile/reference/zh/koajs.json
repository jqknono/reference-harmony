{
  "id": "koajs",
  "name": "Koajs 备忘清单",
  "title": "[![NPM version](https://img.shields.io/npm/v/koa.svg?style=flat)](https://npmjs.org/package/koa)",
  "icon": "https://raw.githubusercontent.com/jaywcjlove/reference/main/assets/koajs.svg",
  "sections": [
    {
      "id": "intro",
      "title": "简介",
      "startIndex": 0
    },
    {
      "id": "s1",
      "title": "入门",
      "startIndex": 2
    }
  ],
  "cards": [
    {
      "id": "intro-0",
      "sectionId": "intro",
      "title": "简介",
      "kind": "text",
      "body": "[![NPM version](https://img.shields.io/npm/v/koa.svg?style=flat)](https://npmjs.org/package/koa)\n[![Downloads](https://img.shields.io/npm/dm/koa.svg?style=flat)](https://www.npmjs.com/package/koa)\n[![Repo Dependents](https://badgen.net/github/dependents-repo/koajs/koa)](https://github.com/koajs/koa/network/dependents)\n[![Github repo](https://badgen.net/badge/icon/Github?icon=github&label)](https://github.com/koajs/koa)"
    },
    {
      "id": "intro-1",
      "sectionId": "intro",
      "title": "简介",
      "kind": "text",
      "body": "基于 Node.js 平台的下一代 web 开发框架，包含 [Koa](https://koajs.com/) 的 API 参考列表和一些示例\n<!--rehype:style=padding-top: 12px;-->"
    },
    {
      "id": "s1-2",
      "sectionId": "s1",
      "title": "Hello World",
      "kind": "text",
      "body": "[Koa](https://koajs.com/) 需要 [node v7.6.0](https://nodejs.org) 或更高版本来支持ES2015、异步方法，你可以安装自己支持的 `node` 版本"
    },
    {
      "id": "s1-3",
      "sectionId": "s1",
      "title": "Hello World",
      "kind": "text",
      "body": "• 安装依赖"
    },
    {
      "id": "s1-4",
      "sectionId": "s1",
      "title": "Hello World",
      "kind": "code",
      "lang": "bash",
      "code": "  $ mkdir myapp # 创建目录\n  $ cd myapp    # 进入目录\n  $ nvm install 7\n  $ npm init -y # 初始化一个配置\n  $ npm install koa # 安装依赖"
    },
    {
      "id": "s1-5",
      "sectionId": "s1",
      "title": "Hello World",
      "kind": "text",
      "body": "• 入口文件 `index.js` 添加代码："
    },
    {
      "id": "s1-6",
      "sectionId": "s1",
      "title": "Hello World",
      "kind": "code",
      "lang": "js",
      "code": "  const Koa = require('koa');\n  const app = new Koa();\n\n  app.use(async ctx => {\n    ctx.body = 'Hello World';\n  });\n\n  app.listen(3000);"
    },
    {
      "id": "s1-7",
      "sectionId": "s1",
      "title": "Hello World",
      "kind": "text",
      "body": "• 使用以下命令运行应用程序"
    },
    {
      "id": "s1-8",
      "sectionId": "s1",
      "title": "Hello World",
      "kind": "code",
      "lang": "bash",
      "code": "  $ node index.js"
    },
    {
      "id": "s1-9",
      "sectionId": "s1",
      "title": "级联",
      "kind": "code",
      "lang": "js",
      "code": "const Koa = require('koa');\nconst app = new Koa();\n// X-Response-Time x 响应时间\napp.use(async (ctx, next) => {\n  const start = Date.now();\n  await next();\n  const ms = Date.now() - start;\n  ctx.set('X-Response-Time', `${ms}ms`);\n});\n// 记录器 logger\napp.use(async (ctx, next) => {\n  const start = Date.now();\n  await next();\n  const ms = Date.now() - start;\n  console.log(\n    `${ctx.method} ${ctx.url} - ${ms}`\n  );\n});\n// 响应 response\napp.use(async ctx => {\n  ctx.body = 'Hello World';\n});\napp.listen(3000);"
    },
    {
      "id": "s1-10",
      "sectionId": "s1",
      "title": "配置",
      "kind": "text",
      "body": ":- | :-\n:- | :-\n`app.env` | 默认为 `NODE_ENV` 或 `development`\n`app.keys` | 签名 `cookie` 密钥数组\n`app.proxy` | 何时信任真正的代理头字段\n`app.subdomainOffset` | 要忽略的 `.subdomains` 的偏移量，默认为 `2`\n`app.proxyIpHeader` | 代理 `ip` 头，默认为 `X-Forwarded-For`\n`app.maxIpsCount` | 从代理 `ip` 头读取的最大 `ips` 数，默认为 `0`（表示无穷大）\n<!--rehype:className=style-list style-list-arrow-->"
    },
    {
      "id": "s1-11",
      "sectionId": "s1",
      "title": "app.callback()",
      "kind": "text",
      "body": ":- | :-\n:- | :-\n`app.listen(...)` [#](https://koajs.com/#app-listen-) | 为一个绑定 `3000` 端口的简单 `Koa` 应用\n`app.callback()` [#](https://koajs.com/#app-callback-) | 返回一个适合 `http.createServer()` 方法的回调函数用来处理请求\n`app.use(function)` [#](https://koajs.com/#app-use-function-) | 添加指定的中间件，详情请看 [Middleware](https://github.com/koajs/koa/wiki#middleware)\n`app.keys` [#](https://koajs.com/#app-keys-) | 设置签名 `cookie` 密钥\n`app.context` [#](https://koajs.com/#app-context) | 从中创建 `ctx` 的原型\n<!--rehype:className=style-list style-list-arrow-->"
    },
    {
      "id": "s1-12",
      "sectionId": "s1",
      "title": "错误处理",
      "kind": "code",
      "lang": "js",
      "code": "app.on('error', (err, ctx) => {\n  log.error('server error', err, ctx)\n});"
    },
    {
      "id": "s1-13",
      "sectionId": "s1",
      "title": "错误处理",
      "kind": "text",
      "body": "默认情况下 `Koa` 会将所有错误信息输出到 `stderr`， 除非 `app.silent` 是 `true`。当 `err.status` 是 `404` 或者 `err.expose` 时，默认错误处理程序也不会输出错误"
    },
    {
      "id": "s1-14",
      "sectionId": "s1",
      "title": "Context 示例",
      "kind": "code",
      "lang": "js",
      "code": "app.use(async ctx => {\n  ctx; // 这是上下文 Context\n  ctx.request;  // 这是 koa Request\n  ctx.response; // 这是 koa Response\n});"
    },
    {
      "id": "s1-15",
      "sectionId": "s1",
      "title": "app.listen(...)",
      "kind": "code",
      "lang": "js",
      "code": "const Koa = require('koa');\nconst app = new Koa();\napp.listen(3000);"
    },
    {
      "id": "s1-16",
      "sectionId": "s1",
      "title": "app.listen(...)",
      "kind": "text",
      "body": "`app.listen(...)` 实际上是以下代码的语法糖:"
    },
    {
      "id": "s1-17",
      "sectionId": "s1",
      "title": "app.listen(...)",
      "kind": "code",
      "lang": "js",
      "code": "const http = require('http');\nconst Koa = require('koa');\nconst app = new Koa();\nhttp.createServer(app.callback()).listen(3000);"
    },
    {
      "id": "s1-18",
      "sectionId": "s1",
      "title": "app.listen(...)",
      "kind": "text",
      "body": "这意味着您可以同时支持 `HTTPS` 和 `HTTPS`，或者在 `多个端口` 监听同一个应用"
    },
    {
      "id": "s1-19",
      "sectionId": "s1",
      "title": "app.listen(...)",
      "kind": "code",
      "lang": "js",
      "code": "const http = require('http');\nconst https = require('https');\nconst Koa = require('koa');\nconst app = new Koa();\nhttp.createServer(app.callback()).listen(3000);\nhttps.createServer(app.callback()).listen(3001);"
    },
    {
      "id": "s1-20",
      "sectionId": "s1",
      "title": "ctx.throw 示例",
      "kind": "code",
      "lang": "js",
      "code": "ctx.throw(400);\nctx.throw(400, 'name required');\nctx.throw(400, 'name required', { user: user });"
    },
    {
      "id": "s1-21",
      "sectionId": "s1",
      "title": "ctx.throw 示例",
      "kind": "text",
      "body": "`this.throw('name required', 400)` 等价于"
    },
    {
      "id": "s1-22",
      "sectionId": "s1",
      "title": "ctx.throw 示例",
      "kind": "code",
      "lang": "js",
      "code": "const err = new Error('name required');\nerr.status = 400;\nerr.expose = true;\nthrow err;"
    },
    {
      "id": "s1-23",
      "sectionId": "s1",
      "title": "ctx.assert 示例",
      "kind": "code",
      "lang": "js",
      "code": "ctx.assert(\n  ctx.state.user,\n  401,\n  'User not found. Please login!'\n);"
    },
    {
      "id": "s1-24",
      "sectionId": "s1",
      "title": "Context(上下文) API",
      "kind": "text",
      "body": ":- | :-\n:- | :-\n`ctx.req` | Node 的 request 对象\n`ctx.res` | Node 的 response 对象\n`ctx.request` | Koa 的 Request 对象\n`ctx.response` | Koa 的 Response 对象\n`ctx.state` | 推荐的命名空间，用于通过中间件传递信息到前端视图\n`ctx.app` | 应用实例引用\n`ctx.app.emit` | 发出由第一个参数定义的类型的事件\n`ctx.cookies.get(name, [options])` | 获得 `cookie` 中名为 `name` 的值\n`ctx.cookies.set(name, value, [options])` | 设置 `cookie` 中名为 `name` 的值\n`ctx.throw([status], [msg], [properties])` | 抛出包含 `.status` 属性的错误，默认为 `500`\n`ctx.assert(value, [status], [msg], [properties])` | 当 `!value` 时， `Helper` 方法抛出一个类似 `.throw()` 的错误\n`ctx.respond` | 避免使用 `Koa` 的内置响应处理功能，您可以直接赋值 `this.repond = false`\n<!--rehype:className=style-list style-list-arrow-->"
    },
    {
      "id": "s1-25",
      "sectionId": "s1",
      "title": "ctx.cookies.set 参数",
      "kind": "text",
      "body": ":- | :-\n:- | :-\n`maxAge` | 表示从Date开始的毫秒数 `now()` 到期。\n`expires` | 一个 `Date` 对象，指示 `cookie` 的到期日期（默认情况下在会话结束时到期）\n`path` | 表示 `cookie` 路径的字符串（默认为`/`）\n`domain` | 表示 `cookie` 的域的字符串（无默认值）\n`secure` | 一个布尔值，指示 `cookie` 是否只通过HTTPS发送（HTTP默认为false，HTTPS默认为true）。阅读有关此选项的更多信息\n`httpOnly` | 一个布尔值，指示cookie是否只通过HTTP（S）发送，而不可用于客户端 JavaScript（默认为true）\n`sameSite` | 一个布尔值或字符串，指示cookie是否为“同一站点”cookie（默认为false）。这可以设置为“strict”、“lax”、“none”或true（映射为“strect”）\n`signed` | 一个布尔值，指示是否对cookie进行签名（默认为false）。如果这是真的，还将发送另一个附加了.sig后缀的同名cookie，其中一个27字节的url安全base64 SHA1值表示cookie name=cookie值相对于第一个Keygrip键的哈希值。此签名密钥用于在下次收到cookie时检测篡改\n`overwrite` | 一个布尔值，指示是否覆盖以前设置的同名 `cookie`（默认为false）。如果为true，则在设置此Cookie时，将从set-Cookie标头中筛选出在同一请求期间设置的具有相同名称的所有Cookie（无论路径或域如何）\n<!--rehype:className=style-list style-list-arrow-->"
    },
    {
      "id": "s1-26",
      "sectionId": "s1",
      "title": "请求(Request)",
      "kind": "text",
      "body": ":- | :-\n:- | :-\n`request.header` | 请求头对象\n`request.header=` | 设置请求头对象\n`request.headers` | 请求头对象。等价于 request.header.\n`request.headers=` | 设置请求头对象。 等价于request.header=.\n`request.method` | 请求方法\n`request.method=` | 设置请求方法, 在实现中间件时非常有用，比如 methodOverride()\n`request.length` | 以数字的形式返回 request 的内容长度(Content-Length)，或者返回 undefined。\n`request.url` | 获得请求url地址.\n`request.url=` | 设置请求地址，用于重写url地址时\n`request.originalUrl` | 获取请求原始地址\n`request.origin` | 获取URL原始地址, 包含 protocol 和 host\n`request.href` | 获取完整的请求URL, 包含 protocol, host 和 url\n`request.path` | 获取请求路径名\n`request.path=` | 设置请求路径名并保留当前查询字符串\n`request.querystring` | 获取查询参数字符串(url中?后面的部分)，不包含?\n`request.querystring=` | 设置原始查询字符串\n`request.search` | 获取查询参数字符串，包含?\n`request.search=` | 设置原始查询字符串\n`request.host` | 获取 host (hostname:port)。 当 app.proxy 设置为 true 时，支持 X-Forwarded-Host\n`request.hostname` | 获取 hostname。当 app.proxy 设置为 true 时，支持 X-Forwarded-Host。\n`request.URL` | 获取 WHATWG 解析的对象.\n`request.type` | 获取请求 Content-Type，不包含像 \"charset\" 这样的参数。\n`request.charset` | 获取请求 charset，没有则返回 `undefined`\n`request.query` | 将查询参数字符串进行解析并以对象的形式返回，如果没有查询参数字字符串则返回一个空对象\n`request.query=` | 根据给定的对象设置查询参数字符串\n`request.fresh` | 检查请求缓存是否 \"fresh\"(内容没有发生变化)\n`request.stale` | 与 req.fresh 相反\n`request.protocol` | 返回请求协议，\"https\" 或者 \"http\"\n`request.secure` | 简化版 this.protocol == \"https\"，用来检查请求是否通过 TLS 发送\n`request.ip` | 请求远程地址，当 app.proxy 设置为 true 时，支持 X-Forwarded-Host\n`request.ips` | 当 X-Forwarded-For 存在并且 app.proxy 有效，将会返回一个有序（从 upstream 到 downstream）ip 数组\n`request.subdomains` | 以数组形式返回子域名\n`request.is(types...)` | 检查请求所包含的 \"Content-Type\" 是否为给定的 type 值\n`request.accepts(types)` | 检查给定的类型 types(s) 是否可被接受，当为 true 时返回最佳匹配，否则返回 false\n`request.acceptsEncodings(encodings)` | 检查 `encodings` 是否可以被接受，当为 `true` 时返回最佳匹配，否则返回 `false`\n`request.acceptsCharsets(charsets)` | 检查 `charsets` 是否可以被接受，如果为 `true` 则返回最佳匹配，否则返回 `false`\n`request.acceptsLanguages(langs)` | 检查 `langs` 是否可以被接受，如果为 `true` 则返回最佳匹配，否则返回 `false`\n`request.idempotent` | 检查请求是否为幂等(idempotent)\n`request.socket` | 返回请求的socket\n`request.get(field)` | 返回请求头\n<!--rehype:className=style-list style-list-arrow-->"
    },
    {
      "id": "s1-27",
      "sectionId": "s1",
      "title": "响应(Response)",
      "kind": "text",
      "body": ":- | :-\n:- | :-\n`response.header` | Response header 对象\n`response.headers` | Response header 对象。等价于 response.header.\n`response.socket` | Request socket.\n`response.status` | 获取响应状态。 默认情况下，response.status设置为404，而不像node's res.statusCode默认为200。\n`response.status=` | 通过数字设置响应状态\n`response.message` | 获取响应状态消息。默认情况下, response.message关联response.status。\n`response.message=` | 将响应状态消息设置为给定值。\n`response.length=` | 将响应Content-Length设置为给定值。\n`response.length` | 如果 Content-Length 作为数值存在，或者可以通过 ctx.body 来进行计算，则返回相应数值，否则返回 undefined。\n`response.body` | 获取响应体。\n`response.body=` | 设置响应体为如 `string`,`Buffer`,`Stream`,`Object\\|Array`,`null`\n`response.get(field)` | 获取 response header 中字段值，field 不区分大小写\n`response.set(field, value)` | 设置 response header 字段 field 的值为 value\n`response.append(field, value)`| 添加额外的字段field 的值为 val\n`response.set(fields)` | 使用对象同时设置 response header 中多个字段的值\n`response.remove(field)` | 移除 response header 中字段 filed\n`response.type` | 获取 response Content-Type，不包含像\"charset\"这样的参数\n`response.type=` | 通过 mime 类型的字符串或者文件扩展名设置 response Content-Type\n`response.is(types...)` | 跟 `ctx.request.is()` 非常类似。用来检查响应类型是否是所提供的类型之一\n`response.redirect(url, [alt])` | 执行 [302] 重定向到对应 url\n`response.attachment([filename])` | 设置 \"attachment\" 的 Content-Disposition，用于给客户端发送信号来提示下载\n`response.headerSent` | 检查 response header 是否已经发送，用于在发生错误时检查客户端是否被通知。\n`response.lastModified` | 如果存在 Last-Modified，则以 Date 的形式返回。\n`response.lastModified=` | 以 UTC 格式设置 Last-Modified。您可以使用 Date 或 date 字符串来进行设置。\n`response.etag=` | 设置 包含 \"s 的 ETag\n`response.vary(field)` | 不同于field.\n`response.flushHeaders()` | 刷新任何设置的响应头，并开始响应体\n<!--rehype:className=style-list style-list-arrow-->"
    },
    {
      "id": "s1-28",
      "sectionId": "s1",
      "title": "请求(Request)别名",
      "kind": "text",
      "body": "以下访问器和别名与 [Request](#请求request) 等价："
    },
    {
      "id": "s1-29",
      "sectionId": "s1",
      "title": "请求(Request)别名",
      "kind": "text",
      "body": "• `ctx.header`\n• `ctx.headers`\n• `ctx.method`\n• `ctx.method=`\n• `ctx.url`\n• `ctx.url=`\n• `ctx.originalUrl`\n• `ctx.origin`\n• `ctx.href`\n• `ctx.path`\n• `ctx.path=`\n• `ctx.query`\n• `ctx.query=`\n• `ctx.querystring`\n• `ctx.querystring=`\n• `ctx.host`\n• `ctx.hostname`\n• `ctx.fresh`\n• `ctx.stale`\n• `ctx.socket`\n• `ctx.protocol`\n• `ctx.secure`\n• `ctx.ip`\n• `ctx.ips`\n• `ctx.subdomains`\n• `ctx.is()`\n• `ctx.accepts()`\n• `ctx.acceptsEncodings()`\n• `ctx.acceptsCharsets()`\n• `ctx.acceptsLanguages()`\n• `ctx.get()`"
    },
    {
      "id": "s1-30",
      "sectionId": "s1",
      "title": "响应(Response)别名",
      "kind": "text",
      "body": "以下访问器和别名与 [Response](#响应response) 等价："
    },
    {
      "id": "s1-31",
      "sectionId": "s1",
      "title": "响应(Response)别名",
      "kind": "text",
      "body": "• `ctx.body`\n• `ctx.body=`\n• `ctx.status`\n• `ctx.status=`\n• `ctx.message`\n• `ctx.message=`\n• `ctx.length=`\n• `ctx.length`\n• `ctx.type=`\n• `ctx.type`\n• `ctx.headerSent`\n• `ctx.redirect()`\n• `ctx.attachment()`\n• `ctx.set()`\n• `ctx.append()`\n• `ctx.remove()`\n• `ctx.lastModified=`\n• `ctx.etag=`"
    },
    {
      "id": "s1-32",
      "sectionId": "s1",
      "title": "request.fresh 示例",
      "kind": "code",
      "lang": "js",
      "code": "// freshness 检查需要状态 20x 或 304\nctx.status = 200;\nctx.set('ETag', '123');\n\n// 缓存正常\nif (ctx.fresh) {\n  ctx.status = 304;\n  return;\n}\n\n// 缓存已过时\n// 获取新数据\nctx.body = await db.find('something');"
    },
    {
      "id": "s1-33",
      "sectionId": "s1",
      "title": "ctx.is 示例",
      "kind": "code",
      "lang": "js",
      "code": "// Content-Type: text/html; charset=utf-8\nctx.is('html'); // => 'html'\nctx.is('text/html'); // => 'text/html'\nctx.is('text/*', 'text/html');\n// => 'text/html'\n// 当 Content-Type 为 application/json 时\nctx.is('json', 'urlencoded'); // => 'json'\nctx.is('application/json');\n// => 'application/json'\nctx.is('html', 'application/*');\n// => 'application/json'\n\nctx.is('html'); // => false"
    },
    {
      "id": "s1-34",
      "sectionId": "s1",
      "title": "ctx.accepts 示例",
      "kind": "code",
      "lang": "js",
      "code": "// 接受: text/*, application/json\nctx.accepts('html');\n// => \"html\"\nctx.accepts('text/html');\n// => \"text/html\"\nctx.accepts('json', 'text');\n// => \"json\"\nctx.accepts('application/json');\n// => \"application/json\""
    },
    {
      "id": "s1-35",
      "sectionId": "s1",
      "title": "request.acceptsCharsets 示例",
      "kind": "code",
      "lang": "js",
      "code": "// Accept-Charset: utf-8, iso-8859-1;q=0.2, utf-7;q=0.5\nctx.acceptsCharsets('utf-8', 'utf-7');\n// => \"utf-8\"\n\nctx.acceptsCharsets(['utf-7', 'utf-8']);\n// => \"utf-8\""
    },
    {
      "id": "s1-36",
      "sectionId": "s1",
      "title": "request.acceptsCharsets 示例",
      "kind": "text",
      "body": "检查 `charsets` 是否可以被接受，如果为 `true` 则返回最佳匹配， 否则返回 `false`"
    },
    {
      "id": "s1-37",
      "sectionId": "s1",
      "title": "response.set 示例",
      "kind": "code",
      "lang": "js",
      "code": "ctx.set({\n  'Etag': '1234',\n  'Last-Modified': date\n});"
    },
    {
      "id": "s1-38",
      "sectionId": "s1",
      "title": "response.set 示例",
      "kind": "text",
      "body": "使用对象同时设置 response header 中多个字段的值"
    },
    {
      "id": "s1-39",
      "sectionId": "s1",
      "title": "response.type 示例",
      "kind": "code",
      "lang": "js",
      "code": "const ct = ctx.type;\n// => \"image/png\""
    },
    {
      "id": "s1-40",
      "sectionId": "s1",
      "title": "response.type 示例",
      "kind": "text",
      "body": "获取 response Content-Type，不包含像\"charset\"这样的参数"
    }
  ],
  "source": {
    "repo": "https://github.com/jaywcjlove/reference",
    "path": "docs/koajs.md",
    "ref": "main",
    "url": "https://github.com/jaywcjlove/reference/tree/main/docs/koajs.md",
    "lang": "zh",
    "mode": "local"
  }
}