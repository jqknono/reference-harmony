{
  "id": "fastapi",
  "name": "FastAPI 备忘清单",
  "title": "一个用于构建 API 的现代、快速（高性能）的 web 框架，使用 Python 3.6+ 并基于标准的 Python 类型提示",
  "icon": "https://raw.githubusercontent.com/jaywcjlove/reference/main/assets/fastapi.svg",
  "sections": [
    {
      "id": "intro",
      "title": "简介",
      "startIndex": 0
    },
    {
      "id": "s1",
      "title": "入门",
      "startIndex": 1
    },
    {
      "id": "s2",
      "title": "依赖项",
      "startIndex": 77
    },
    {
      "id": "s3",
      "title": "安全性",
      "startIndex": 93
    },
    {
      "id": "s4",
      "title": "参考",
      "startIndex": 112
    }
  ],
  "cards": [
    {
      "id": "intro-0",
      "sectionId": "intro",
      "title": "简介",
      "kind": "text",
      "body": "一个用于构建 API 的现代、快速（高性能）的 web 框架，使用 Python 3.6+ 并基于标准的 Python 类型提示"
    },
    {
      "id": "s1-1",
      "sectionId": "s1",
      "title": "安装 FastAPI",
      "kind": "code",
      "lang": "shell",
      "code": "$ pip install \"fastapi[all]\""
    },
    {
      "id": "s1-2",
      "sectionId": "s1",
      "title": "安装 FastAPI",
      "kind": "text",
      "body": "#### 可以分开来安装"
    },
    {
      "id": "s1-3",
      "sectionId": "s1",
      "title": "安装 FastAPI",
      "kind": "text",
      "body": "假如你想将应用程序部署到生产环境，你可能要执行以下操作："
    },
    {
      "id": "s1-4",
      "sectionId": "s1",
      "title": "安装 FastAPI",
      "kind": "code",
      "lang": "shell",
      "code": "$ pip install fastapi"
    },
    {
      "id": "s1-5",
      "sectionId": "s1",
      "title": "安装 FastAPI",
      "kind": "text",
      "body": "并且安装 `uvicorn` 来作为服务器："
    },
    {
      "id": "s1-6",
      "sectionId": "s1",
      "title": "安装 FastAPI",
      "kind": "code",
      "lang": "shell",
      "code": "$ pip install \"uvicorn[standard]\""
    },
    {
      "id": "s1-7",
      "sectionId": "s1",
      "title": "安装 FastAPI",
      "kind": "text",
      "body": "#### 运行代码"
    },
    {
      "id": "s1-8",
      "sectionId": "s1",
      "title": "安装 FastAPI",
      "kind": "code",
      "lang": "shell",
      "code": "$ uvicorn main:app --reload"
    },
    {
      "id": "s1-9",
      "sectionId": "s1",
      "title": "安装 FastAPI",
      "kind": "text",
      "body": "Python: `3.9.5` FastAPI: `0.103.1`"
    },
    {
      "id": "s1-10",
      "sectionId": "s1",
      "title": "最小程序",
      "kind": "text",
      "body": "下面代码会直接启动http服务，也可以使用 `uvicorn main:app --reload`"
    },
    {
      "id": "s1-11",
      "sectionId": "s1",
      "title": "最小程序",
      "kind": "code",
      "lang": "python",
      "code": "from fastapi import FastAPI\nimport uvicorn\n\napp = FastAPI()"
    },
    {
      "id": "s1-12",
      "sectionId": "s1",
      "title": "最小程序",
      "kind": "text",
      "body": "添加一个 API 的示例"
    },
    {
      "id": "s1-13",
      "sectionId": "s1",
      "title": "最小程序",
      "kind": "code",
      "lang": "python",
      "code": "# http://127.0.0.1:8000/\n@app.get(\"/\")\nasync def root():\n    return {\"message\": \"Hello World\"}\n\nif __name__ == '__main__':\n    uvicorn.run(app='main:app', reload=True)"
    },
    {
      "id": "s1-14",
      "sectionId": "s1",
      "title": "路径参数",
      "kind": "text",
      "body": "#### 最基本的路径参数"
    },
    {
      "id": "s1-15",
      "sectionId": "s1",
      "title": "路径参数",
      "kind": "code",
      "lang": "python",
      "code": "# http://127.0.0.1:8000/items/1\n@app.get(\"/items/{item_id}\")\nasync def read_item(item_id):\n    return {\"item_id\": item_id} # item_id自定义"
    },
    {
      "id": "s1-16",
      "sectionId": "s1",
      "title": "路径参数",
      "kind": "text",
      "body": "#### 多个路径参数"
    },
    {
      "id": "s1-17",
      "sectionId": "s1",
      "title": "路径参数",
      "kind": "code",
      "lang": "python",
      "code": "# http://127.0.0.1:8000/items/1/2\n@app.get(\"/items/{item_id}/{user_id}\")\nasync def read_item(item_id, user_id):\n    return {\"item_id\": item_id, \"user_id\": user_id}"
    },
    {
      "id": "s1-18",
      "sectionId": "s1",
      "title": "路径参数",
      "kind": "text",
      "body": "#### 有类型的路径参数"
    },
    {
      "id": "s1-19",
      "sectionId": "s1",
      "title": "路径参数",
      "kind": "code",
      "lang": "python",
      "code": "# http://127.0.0.1:8000/items/1\n@app.get(\"/items/{item_id}\")\nasync def read_item(item_id: int):\n    return {\"item_id\": item_id}"
    },
    {
      "id": "s1-20",
      "sectionId": "s1",
      "title": "路径参数",
      "kind": "text",
      "body": "#### 文件路径参数"
    },
    {
      "id": "s1-21",
      "sectionId": "s1",
      "title": "路径参数",
      "kind": "code",
      "lang": "python",
      "code": "# http://127.0.0.1:8000/file//home/my/my.txt\n@app.get(\"/file/{file_path:path}\")\nasync def read_item(file_path):\n    return {\"file_path\": file_path}"
    },
    {
      "id": "s1-22",
      "sectionId": "s1",
      "title": "查询参数",
      "kind": "text",
      "body": "#### 带默认值的查询参数"
    },
    {
      "id": "s1-23",
      "sectionId": "s1",
      "title": "查询参数",
      "kind": "code",
      "lang": "python",
      "code": "# http://127.0.0.1:8000/items/?skip=0&limit=2\nfake_items_db = [{\"item_name\": \"Foo\"}, {\"item_name\": \"Bar\"}]\n\n@app.get(\"/items/\")\nasync def read_item(skip: int = 0, limit: int = 10):\n    return fake_items_db[skip: skip + limit]"
    },
    {
      "id": "s1-24",
      "sectionId": "s1",
      "title": "查询参数",
      "kind": "text",
      "body": "#### 可选查询参数"
    },
    {
      "id": "s1-25",
      "sectionId": "s1",
      "title": "查询参数",
      "kind": "code",
      "lang": "python",
      "code": "# http://127.0.0.1:8000/items/1?q=admin\nfrom typing import Union\n\n@app.get(\"/items/{item_id}\")\nasync def read_item(item_id: str, q: Union[str, None] = None):\n    if q:\n        return {\"item_id\": item_id, \"q\": q}\n    return {\"item_id\": item_id}"
    },
    {
      "id": "s1-26",
      "sectionId": "s1",
      "title": "查询参数",
      "kind": "text",
      "body": "#### 多路径多查询参数"
    },
    {
      "id": "s1-27",
      "sectionId": "s1",
      "title": "查询参数",
      "kind": "code",
      "lang": "python",
      "code": "# http://127.0.0.1:8000/users/1/items/2\n# or \n# http://127.0.0.1:8000/users/1/items/2?q=query&short=true\n@app.get(\"/users/{user_id}/items/{item_id}\")\nasync def read_user_item(\n    user_id: int, \n    item_id: str, \n    q: Union[str, None] = None, \n    short: bool = False\n):\n    item = {\"item_id\": item_id, \"owner_id\": user_id}\n    if q:\n        item.update({\"q\": q})\n    if not short:\n        item.update(\n            {\"description\": \"这是一个令人惊叹的项目，有很长的描述\"}\n        )\n    return item"
    },
    {
      "id": "s1-28",
      "sectionId": "s1",
      "title": "查询参数",
      "kind": "text",
      "body": "#### 必需查询参数"
    },
    {
      "id": "s1-29",
      "sectionId": "s1",
      "title": "查询参数",
      "kind": "code",
      "lang": "python",
      "code": "# http://127.0.0.1:8000/items/123?needy=yes\n@app.get(\"/items/{item_id}\")\nasync def read_user_item(item_id: str, needy: str):\n    item = {\"item_id\": item_id, \"needy\": needy}\n    return item"
    },
    {
      "id": "s1-30",
      "sectionId": "s1",
      "title": "请求体",
      "kind": "code",
      "lang": "python",
      "code": "from pydantic import BaseModel\nfrom typing import Union\n\nclass Item(BaseModel):\n    name: str = '小明'\n    description: Union[str, None] = None\n    price: float\n    tax: Union[float, None] = None\n\n@app.post(\"/items/\")\nasync def create_item(item: Item):\n    print(item.name)\n    return item"
    },
    {
      "id": "s1-31",
      "sectionId": "s1",
      "title": "请求体",
      "kind": "text",
      "body": "#### 调用"
    },
    {
      "id": "s1-32",
      "sectionId": "s1",
      "title": "请求体",
      "kind": "code",
      "lang": "bash",
      "code": "curl -X 'POST' \\\n  'http://127.0.0.1:8000/items/' \\\n  -H 'accept: application/json' \\\n  -H 'Content-Type: application/json' \\\n  -d '{\n  \"name\": \"小明\",\n  \"description\": \"string\",\n  \"price\": 0,\n  \"tax\": 0\n}'"
    },
    {
      "id": "s1-33",
      "sectionId": "s1",
      "title": "查询参数和字符串校验",
      "kind": "code",
      "lang": "python",
      "code": "from fastapi import Query\n\n@app.get(\"/items/\")\nasync def read_items(\n    q: Union[str, None] = Query(default=None, max_length=50)\n):\n    results = {\"items\": [{\"item_id\": \"Foo\"}, {\"item_id\": \"Bar\"}]}\n    if q:\n        results.update({\"q\": q})\n    return results"
    },
    {
      "id": "s1-34",
      "sectionId": "s1",
      "title": "查询参数和字符串校验",
      "kind": "text",
      "body": "#### 参数列表"
    },
    {
      "id": "s1-35",
      "sectionId": "s1",
      "title": "查询参数和字符串校验",
      "kind": "qa",
      "front": "`default`",
      "back": "默认值 | 任意类型或..."
    },
    {
      "id": "s1-36",
      "sectionId": "s1",
      "title": "查询参数和字符串校验",
      "kind": "qa",
      "front": "`max_length`",
      "back": "最大长度 | `int`"
    },
    {
      "id": "s1-37",
      "sectionId": "s1",
      "title": "查询参数和字符串校验",
      "kind": "qa",
      "front": "`min_length`",
      "back": "最小长度 | `int`"
    },
    {
      "id": "s1-38",
      "sectionId": "s1",
      "title": "查询参数和字符串校验",
      "kind": "qa",
      "front": "`pattern`",
      "back": "正则匹配 | `string`"
    },
    {
      "id": "s1-39",
      "sectionId": "s1",
      "title": "查询参数和字符串校验",
      "kind": "qa",
      "front": "`alias`",
      "back": "别名参数 | `string`"
    },
    {
      "id": "s1-40",
      "sectionId": "s1",
      "title": "查询参数和字符串校验",
      "kind": "qa",
      "front": "`deprecated`",
      "back": "准备弃用参数 | `bool`"
    },
    {
      "id": "s1-41",
      "sectionId": "s1",
      "title": "查询参数和字符串校验",
      "kind": "text",
      "body": "#### 多个相同的查询参数"
    },
    {
      "id": "s1-42",
      "sectionId": "s1",
      "title": "查询参数和字符串校验",
      "kind": "code",
      "lang": "python",
      "code": "# http://127.0.0.1:8000/items/?q=foo&q=bar\n@app.get(\"/items/\")\nasync def read_items(\n    q: Union[List[str], None] = Query(default=None)\n):\n    query_items = {\"q\": q}\n    return query_items"
    },
    {
      "id": "s1-43",
      "sectionId": "s1",
      "title": "路径参数和数值校验",
      "kind": "text",
      "body": "Path 用法基本和 Query 相同，参考：[FastAPI官方文档](https://fastapi.tiangolo.com/zh/tutorial/path-params-numeric-validations/)"
    },
    {
      "id": "s1-44",
      "sectionId": "s1",
      "title": "路径参数和数值校验",
      "kind": "text",
      "body": "#### 导入 Path"
    },
    {
      "id": "s1-45",
      "sectionId": "s1",
      "title": "路径参数和数值校验",
      "kind": "code",
      "lang": "python",
      "code": "from fastapi import FastAPI, Path, Query\nfrom typing_extensions import Annotated"
    },
    {
      "id": "s1-46",
      "sectionId": "s1",
      "title": "路径参数和数值校验",
      "kind": "text",
      "body": "#### 声明元数据"
    },
    {
      "id": "s1-47",
      "sectionId": "s1",
      "title": "路径参数和数值校验",
      "kind": "code",
      "lang": "python",
      "code": "@app.get(\"/items/{item_id}\")\nasync def read_items(\n    item_id: Annotated[int, Path(title=\"要获取的项目的 ID\")],\n    q: Annotated[str | None, Query(alias=\"item-query\")] = None,\n):\n    results = {\"item_id\": item_id}\n    if q:\n        results.update({\"q\": q})\n    return results"
    },
    {
      "id": "s1-48",
      "sectionId": "s1",
      "title": "路径参数和数值校验",
      "kind": "text",
      "body": "#### 参数列表"
    },
    {
      "id": "s1-49",
      "sectionId": "s1",
      "title": "路径参数和数值校验",
      "kind": "qa",
      "front": "`...`",
      "back": "和 Query 具有相同参数 | ..."
    },
    {
      "id": "s1-50",
      "sectionId": "s1",
      "title": "路径参数和数值校验",
      "kind": "qa",
      "front": "`ge`",
      "back": "大于等于 | `int float`"
    },
    {
      "id": "s1-51",
      "sectionId": "s1",
      "title": "路径参数和数值校验",
      "kind": "qa",
      "front": "`gt`",
      "back": "大于 | `int float`"
    },
    {
      "id": "s1-52",
      "sectionId": "s1",
      "title": "路径参数和数值校验",
      "kind": "qa",
      "front": "`le`",
      "back": "小于等于 | `int float`"
    },
    {
      "id": "s1-53",
      "sectionId": "s1",
      "title": "路径参数和数值校验",
      "kind": "qa",
      "front": "`le`",
      "back": "小于等于 | `int float`"
    },
    {
      "id": "s1-54",
      "sectionId": "s1",
      "title": "路径参数和数值校验",
      "kind": "qa",
      "front": "`title`",
      "back": "api文档的标题 | `string`"
    },
    {
      "id": "s1-55",
      "sectionId": "s1",
      "title": "其他参数",
      "kind": "text",
      "body": "都具有 `Query` 的参数，`max_length`、`min_length` 等"
    },
    {
      "id": "s1-56",
      "sectionId": "s1",
      "title": "其他参数",
      "kind": "text",
      "body": "#### Cookie参数"
    },
    {
      "id": "s1-57",
      "sectionId": "s1",
      "title": "其他参数",
      "kind": "code",
      "lang": "python",
      "code": "from fastapi import Cookie\n\n@app.get(\"/items/\")\nasync def read_items(\n    ads_id: Annotated[Union[str, None], Cookie()] = None\n):\n    return {\"ads_id\": ads_id}"
    },
    {
      "id": "s1-58",
      "sectionId": "s1",
      "title": "其他参数",
      "kind": "text",
      "body": "#### Header 参数"
    },
    {
      "id": "s1-59",
      "sectionId": "s1",
      "title": "其他参数",
      "kind": "code",
      "lang": "python",
      "code": "from fastapi import Header\n\n@app.get(\"/items/\")\nasync def read_items(\n    user_agent: Annotated[Union[str, None], Header()] = None,\n    items_id: Annotated[Union[int, None], Header(ge=1)] = None\n):\n    return {\"User-Agent\": user_agent, \"items_id\": items_id}"
    },
    {
      "id": "s1-60",
      "sectionId": "s1",
      "title": "表单数据",
      "kind": "text",
      "body": "接收的不是 JSON，而是表单字段时，要使用 Form。"
    },
    {
      "id": "s1-61",
      "sectionId": "s1",
      "title": "表单数据",
      "kind": "text",
      "body": "#### 安装"
    },
    {
      "id": "s1-62",
      "sectionId": "s1",
      "title": "表单数据",
      "kind": "code",
      "lang": "shell",
      "code": "$ pip install python-multipart"
    },
    {
      "id": "s1-63",
      "sectionId": "s1",
      "title": "表单数据",
      "kind": "text",
      "body": "#### HTML"
    },
    {
      "id": "s1-64",
      "sectionId": "s1",
      "title": "表单数据",
      "kind": "code",
      "lang": "html",
      "code": "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n<meta charset=\"UTF-8\">\n</head>\n<body>\n<form method=\"post\" action=\"http://127.0.0.1:8000/login\">\n    <span>账号：</span><input type=\"text\" name=\"username\">\n    <br>\n    <span>密码：</span><input type=\"password\" name=\"password\">\n    <br>\n    <input type=\"submit\" value=\"登录\">\n</form>\n</body>\n</html>"
    },
    {
      "id": "s1-65",
      "sectionId": "s1",
      "title": "表单数据",
      "kind": "text",
      "body": "#### FastAPI"
    },
    {
      "id": "s1-66",
      "sectionId": "s1",
      "title": "表单数据",
      "kind": "code",
      "lang": "python",
      "code": "from fastapi import FastAPI, Form\nimport uvicorn\napp = FastAPI()\n@app.post(\"/login/\")\nasync def login(username: str = Form(), password: str = Form()):\n    return {\"username\": username}\nif __name__ == '__main__':\n    uvicorn.run(app='main:app', reload=True)"
    },
    {
      "id": "s1-67",
      "sectionId": "s1",
      "title": "文件上传",
      "kind": "code",
      "lang": "python",
      "code": "from fastapi import FastAPI, UploadFile\nfrom fastapi.responses import HTMLResponse\n\n@app.post(\"/uploadfile/\")\nasync def create_upload_file(file: UploadFile):\n    print(file.file.read().decode())\n    return {\"filenames\": file.filename, \"type\": str(type(file.file))}\n\n@app.get(\"/\")\nasync def main():\n    content = \"\"\"<body>\n<form action=\"/uploadfile/\" enctype=\"multipart/form-data\" method=\"post\">\n<input name=\"file\" type=\"file\" multiple>\n<input type=\"submit\">\n</form>\n</body>\"\"\"\n    return HTMLResponse(content=content)"
    },
    {
      "id": "s1-68",
      "sectionId": "s1",
      "title": "文件上传",
      "kind": "text",
      "body": "#### UploadFile 属性"
    },
    {
      "id": "s1-69",
      "sectionId": "s1",
      "title": "文件上传",
      "kind": "qa",
      "front": "`filename`",
      "back": "文件名 | 上传的文件名"
    },
    {
      "id": "s1-70",
      "sectionId": "s1",
      "title": "文件上传",
      "kind": "qa",
      "front": "`content_type`",
      "back": "内容类型 | `MIME` 类型"
    },
    {
      "id": "s1-71",
      "sectionId": "s1",
      "title": "文件上传",
      "kind": "qa",
      "front": "`file`",
      "back": "文件 | SpooledTemporaryFile 具有 `read`，`write` 方法"
    },
    {
      "id": "s1-72",
      "sectionId": "s1",
      "title": "文件上传",
      "kind": "text",
      "body": "#### UploadFile async 方法"
    },
    {
      "id": "s1-73",
      "sectionId": "s1",
      "title": "文件上传",
      "kind": "qa",
      "front": "`write(data)`",
      "back": "把 `data` 写入文件"
    },
    {
      "id": "s1-74",
      "sectionId": "s1",
      "title": "文件上传",
      "kind": "qa",
      "front": "`read(size)`",
      "back": "按指定数量的字节读取文件内容"
    },
    {
      "id": "s1-75",
      "sectionId": "s1",
      "title": "文件上传",
      "kind": "qa",
      "front": "`seek(offset)`",
      "back": "移动至文件 `offset` （`int`）字节处的位置"
    },
    {
      "id": "s1-76",
      "sectionId": "s1",
      "title": "文件上传",
      "kind": "qa",
      "front": "`close()`",
      "back": "关闭文件"
    },
    {
      "id": "s2-77",
      "sectionId": "s2",
      "title": "依赖项使用场景",
      "kind": "text",
      "body": "• 共享业务逻辑（复用相同的代码逻辑）\n• 共享数据库连接\n• 实现安全、验证、角色权限\n• 等……"
    },
    {
      "id": "s2-78",
      "sectionId": "s2",
      "title": "创建依赖项",
      "kind": "code",
      "lang": "python",
      "code": "from typing import Union\n\nfrom fastapi import Depends, FastAPI\n\napp = FastAPI()"
    },
    {
      "id": "s2-79",
      "sectionId": "s2",
      "title": "创建依赖项",
      "kind": "text",
      "body": "`read_items` 和 `read_users` 方法依赖 `common_parameters`\n白话就是 `read_items` 和 `read_users` 都需要 `q`，`skip`，`limit` 查询参数"
    },
    {
      "id": "s2-80",
      "sectionId": "s2",
      "title": "创建依赖项",
      "kind": "code",
      "lang": "python",
      "code": "async def common_parameters(\n    q: Union[str, None] = None,\n    skip: int = 0,\n    limit: int = 100\n):\n    return {\"q\": q, \"skip\": skip, \"limit\": limit}\n\n\n@app.get(\"/items/\")\nasync def read_items(\n    commons: dict = Depends(common_parameters)\n):\n    return commons\n\n\n@app.get(\"/users/\")\nasync def read_users(\n    commons: dict = Depends(common_parameters)\n):\n    return commons"
    },
    {
      "id": "s2-81",
      "sectionId": "s2",
      "title": "类作为依赖项",
      "kind": "code",
      "lang": "python",
      "code": "from typing import Union\nfrom fastapi import Depends, FastAPI\n\napp = FastAPI()\nfake_items_db = [{\"item_name\": \"Foo\"}, {\"item_name\": \"Bar\"}]\n\nclass CommonQueryParams:\n    def __init__(\n        self, \n        q: Union[str, None] = None, \n        skip: int = 0, \n        limit: int = 100\n    ):\n        self.q = q\n        self.skip = skip\n        self.limit = limit"
    },
    {
      "id": "s2-82",
      "sectionId": "s2",
      "title": "类作为依赖项",
      "kind": "text",
      "body": "`read_itemsx` 接收一个 `commons` 参数，类型是 `CommonQueryParams`\n`CommonQueryParams` 接收三个参数，这三个参数是调用 api 的时候传"
    },
    {
      "id": "s2-83",
      "sectionId": "s2",
      "title": "类作为依赖项",
      "kind": "code",
      "lang": "python",
      "code": "@app.get(\"/items/\")\nasync def read_items(\n  commons: CommonQueryParams = Depends(CommonQueryParams)\n):\n  response = {}\n  if commons.q:\n      response.update({\"q\": commons.q})\n  items = fake_items_db[commons.skip : commons.skip + commons.limit]\n  response.update({\"items\": items})\n  return response"
    },
    {
      "id": "s2-84",
      "sectionId": "s2",
      "title": "类作为依赖项",
      "kind": "text",
      "body": "#### 还可以简写"
    },
    {
      "id": "s2-85",
      "sectionId": "s2",
      "title": "类作为依赖项",
      "kind": "code",
      "lang": "python",
      "code": "@app.get(\"/items/\")\nasync def read_items(\n  # 这里的 Depends 没有传参，FastAPI 会自动使用 CommonQueryParams\n  commons: CommonQueryParams = Depends()\n):\n  response = {}\n  if commons.q:\n      response.update({\"q\": commons.q})\n  items = fake_items_db[commons.skip : commons.skip + commons.limit]\n  response.update({\"items\": items})\n  return response"
    },
    {
      "id": "s2-86",
      "sectionId": "s2",
      "title": "子依赖项",
      "kind": "code",
      "lang": "python",
      "code": "from typing import Union\nfrom fastapi import Cookie, Depends, FastAPI\n\napp = FastAPI()\n\ndef query_extractor(q: Union[str, None] = None):\n    return q\n\ndef query_or_cookie_extractor(\n    q: str = Depends(query_extractor),\n    last_query: Union[str, None] = Cookie(default=None),\n):\n    if not q:\n        return last_query\n    return q\n\n# read_query函数依赖query_or_cookie_extractor函数\n# query_or_cookie_extractor函数又依赖query_extractor函数\n# 就是说依赖项可以依赖其他依赖项，只要你不晕，可以无数次套娃\n@app.get(\"/items/\")\nasync def read_query(\n  query_or_default: str = Depends(query_or_cookie_extractor)\n):\n    return {\"q_or_cookie\": query_or_default}"
    },
    {
      "id": "s2-87",
      "sectionId": "s2",
      "title": "子依赖项",
      "kind": "text",
      "body": "#### 不使用缓存"
    },
    {
      "id": "s2-88",
      "sectionId": "s2",
      "title": "子依赖项",
      "kind": "text",
      "body": "使用 `use_cache = False` 参数不使用缓存数据，不使用 `use_cache = False`，`value` 和 `value1` 是一样的"
    },
    {
      "id": "s2-89",
      "sectionId": "s2",
      "title": "子依赖项",
      "kind": "code",
      "lang": "python",
      "code": "def result_value():\n    value = randint(1, 99)\n    return value\n\ndef get_value(\n  value: int = Depends(result_value, use_cache=False),\n  value1: int = Depends(result_value, use_cache=False)\n):\n    return value, value1\n\n@app.get('/value/')\nasync def needy_dependency(value: tuple = Depends(get_value)):\n    return {\"value\": value}"
    },
    {
      "id": "s2-90",
      "sectionId": "s2",
      "title": "全局依赖项",
      "kind": "code",
      "lang": "python",
      "code": "from fastapi import Depends, FastAPI, Header, HTTPException\n\nasync def verify_token(x_token: str = Header()):\n  if x_token != \"fake-super-secret-token\":\n    raise HTTPException(status_code=400, detail=\"X-Token 标头无效\")\n\nasync def verify_key(x_key: str = Header()):\n  if x_key != \"fake-super-secret-key\":\n    raise HTTPException(status_code=400, detail=\"X-Key 标头无效\")\n  return x_key"
    },
    {
      "id": "s2-91",
      "sectionId": "s2",
      "title": "全局依赖项",
      "kind": "text",
      "body": "全局依赖项很有用，后面的安全性就可以使用全局依赖项"
    },
    {
      "id": "s2-92",
      "sectionId": "s2",
      "title": "全局依赖项",
      "kind": "code",
      "lang": "python",
      "code": "app = FastAPI(\n  dependencies=[Depends(verify_token), Depends(verify_key)]\n)\n\n@app.get(\"/items/\")\nasync def read_items():\n    return [{\"item\": \"Portal Gun\"}, {\"item\": \"Plumbus\"}]\n\n@app.get(\"/users/\")\nasync def read_users():\n    return [{\"username\": \"Rick\"}, {\"username\": \"Morty\"}]"
    },
    {
      "id": "s3-93",
      "sectionId": "s3",
      "title": "基于 Token 的认证",
      "kind": "code",
      "lang": "python",
      "code": "from fastapi import FastAPI, Depends, HTTPException\nfrom fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm\nfrom pydantic import BaseModel\n\napp = FastAPI()"
    },
    {
      "id": "s3-94",
      "sectionId": "s3",
      "title": "基于 Token 的认证",
      "kind": "text",
      "body": "使用 OAuth2PasswordBearer 创建一个 token 依赖"
    },
    {
      "id": "s3-95",
      "sectionId": "s3",
      "title": "基于 Token 的认证",
      "kind": "code",
      "lang": "python",
      "code": "oauth2_scheme = OAuth2PasswordBearer(tokenUrl=\"token\")"
    },
    {
      "id": "s3-96",
      "sectionId": "s3",
      "title": "基于 Token 的认证",
      "kind": "text",
      "body": "假设这是你的用户数据库"
    },
    {
      "id": "s3-97",
      "sectionId": "s3",
      "title": "基于 Token 的认证",
      "kind": "code",
      "lang": "python",
      "code": "fake_users_db = {\n    \"johndoe\": {\n        \"username\": \"johndoe\",\n        \"full_name\": \"John Doe\",\n        \"email\": \"johndoe@example.com\",\n        \"hashed_password\": \"fakehashedsecret\",\n        \"disabled\": False,\n    }\n}"
    },
    {
      "id": "s3-98",
      "sectionId": "s3",
      "title": "基于 Token 的认证",
      "kind": "text",
      "body": "创建一个用户模型"
    },
    {
      "id": "s3-99",
      "sectionId": "s3",
      "title": "基于 Token 的认证",
      "kind": "code",
      "lang": "python",
      "code": "class User(BaseModel):\n    username: str\n    email: str\n    full_name: str\n    disabled: bool"
    },
    {
      "id": "s3-100",
      "sectionId": "s3",
      "title": "基于 Token 的认证",
      "kind": "text",
      "body": "创建一个简单的认证函数"
    },
    {
      "id": "s3-101",
      "sectionId": "s3",
      "title": "基于 Token 的认证",
      "kind": "code",
      "lang": "python",
      "code": "def fake_hash_password(password: str):\n    return \"fakehashed\" + password\n\ndef get_user(db, username: str):\n    if username in db:\n        user_dict = db[username]\n        return User(**user_dict)\n\ndef fake_decode_token(token: str):\n    # 这个函数应该验证 token 并返回用户信息\n    # 这里我们只是简单地返回了用户名\n    return get_user(fake_users_db, token)"
    },
    {
      "id": "s3-102",
      "sectionId": "s3",
      "title": "基于 Token 的认证",
      "kind": "text",
      "body": "创建一个依赖，用于从请求中获取 token 并验证用户"
    },
    {
      "id": "s3-103",
      "sectionId": "s3",
      "title": "基于 Token 的认证",
      "kind": "code",
      "lang": "python",
      "code": "async def get_current_user(token: str = Depends(oauth2_scheme)):\n    user = fake_decode_token(token)\n    if not user:\n        raise HTTPException(\n            status_code=401,\n            detail=\"Invalid authentication credentials\",\n            headers={\"WWW-Authenticate\": \"Bearer\"},\n        )\n    return user\n\n@app.post(\"/token\")\nasync def login(form_data: OAuth2PasswordRequestForm = Depends()):\n    user = get_user(fake_users_db, form_data.username)\n    if not user or user.hashed_password != fake_hash_password(form_data.password):\n        raise HTTPException(status_code=400, detail=\"Incorrect username or password\")\n    return {\"access_token\": user.username, \"token_type\": \"bearer\"}\n\n@app.get(\"/users/me\")\nasync def read_users_me(current_user: User = Depends(get_current_user)):\n    return current_user"
    },
    {
      "id": "s3-104",
      "sectionId": "s3",
      "title": "基于 Token 的认证",
      "kind": "text",
      "body": "使用 OAuth2PasswordBearer 来创建一个简单的 token 认证流程。"
    },
    {
      "id": "s3-105",
      "sectionId": "s3",
      "title": "HTTPS 和证书",
      "kind": "code",
      "lang": "python",
      "code": "from fastapi import FastAPI\n\napp = FastAPI()"
    },
    {
      "id": "s3-106",
      "sectionId": "s3",
      "title": "HTTPS 和证书",
      "kind": "text",
      "body": "在生产环境中，你应该使用一个真正的证书和私钥，你可以从像 Let's Encrypt 这样的证书颁发机构获得免费的证书，或者使用 OpenSSL 生成自签名证书"
    },
    {
      "id": "s3-107",
      "sectionId": "s3",
      "title": "HTTPS 和证书",
      "kind": "code",
      "lang": "python",
      "code": "@app.get(\"/https\")\nasync def read_https():\n    return {\"message\": \"Hello, HTTPS!\"}"
    },
    {
      "id": "s3-108",
      "sectionId": "s3",
      "title": "HTTPS 和证书",
      "kind": "text",
      "body": "启动服务器时，使用以下命令来指定证书和私钥："
    },
    {
      "id": "s3-109",
      "sectionId": "s3",
      "title": "HTTPS 和证书",
      "kind": "code",
      "lang": "bash",
      "code": "uvicorn main:app --host 0.0.0.0 --port 443 --ssl-keyfile /path/to/your/key.pem --ssl-certfile /path/to/your/cert.pem"
    },
    {
      "id": "s3-110",
      "sectionId": "s3",
      "title": "HTTPS 和证书",
      "kind": "text",
      "body": "FastAPI 默认支持 HTTPS，你只需要提供证书和私钥即可。"
    },
    {
      "id": "s3-111",
      "sectionId": "s3",
      "title": "HTTPS 和证书",
      "kind": "text",
      "body": "待更新"
    },
    {
      "id": "s4-112",
      "sectionId": "s4",
      "title": "参考",
      "kind": "text",
      "body": "• [Python 备忘清单](./python.md) _(jaywcjlove.github.io)_\n• [FastAPI 官方文档](https://fastapi.tiangolo.com/zh/tutorial/) _(fastapi.tiangolo.com)_"
    }
  ],
  "source": {
    "repo": "https://github.com/jaywcjlove/reference",
    "path": "docs/fastapi.md",
    "ref": "main",
    "url": "https://github.com/jaywcjlove/reference/tree/main/docs/fastapi.md",
    "lang": "zh",
    "mode": "local"
  }
}